<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Atlas tester</title>
</head>
<body>

    <h3>Atlas tester</h3>
    <p>Atlas received message:</p>
    <div id="results"></div>
    <p>Send data to atlas: <button id="message_button">Send</button></p>
    <br/>
    <script src='js/createIcon.js'></script>
    <script src='js/createInfoDisplay.js'></script>
    <script>

        const ATLAS_TYPE = 'add divesite';
          // 'show place','show divesite', 'atlas',
          // 'add divesite','add divesite parking','add place'

        var messageButton = document.getElementById('message_button');
		var results = document.getElementById('results');

        // create the atlas iframe
        var iframeSource = 'atlas.html';
        var iframe = document.createElement('iframe');
        iframe.setAttribute('src', iframeSource);
        iframe.setAttribute('id', 'atlas_iframe');
        iframe.style.width = 200 + 'px';
        iframe.style.height = 200 + 'px';
        document.body.appendChild(iframe);
		var atlasElement = document.getElementById('atlas_iframe').contentWindow;
        
        // create the data
        var mapData = {
          googleKey: 'AIzaSyCRLnmaReDL6IFS7YRrfGmHjKvYtZw60Fg',
          navionicsKey: 'Navionics_webapi_03362',
          atlasType: ATLAS_TYPE,
        };

		// receive and display messages from the map
        window.addEventListener('message',
          (e) => {
            results.innerHTML = JSON.stringify(e.data)
            if (e.data.type==='ready') {
              atlasElement.postMessage(JSON.stringify(mapData), '*');
            }
          });
        
        // Add a new random marker to the mapData on every button click
		messageButton.addEventListener('click',
          function (e) {
            updateMapData({atlasType: mapData.atlasType});
            atlasElement.postMessage(JSON.stringify(mapData), '*');
          }
		)

		function updateMapData({atlasType}) {
          // randomness options
          var names = ['my muff','cenote','hello','happy place','ibiza'];
          var types = ['site','parking','pool','school','trip','event'];
          var compTypes = ['depth competition','pool competition',
                           'mixed competition','judge course','workshop/camp'];
                                       
          var lat = (Math.random()-0.5)*120;
          var lng = (Math.random()-0.5)*360;
          var name = names[Math.floor(Math.random()*names.length)];
          var type = types[Math.floor(Math.random()*types.length)];
          var compType = (type==='event') ?
            compTypes[Math.floor(Math.random()*compTypes.length)] :
            '';
          // need name, lat, lng, icon, info
          randomMarker = {name,lat,lng,type,compType};
          [randomMarker.icon,randomMarker.iconSpiderfiable] = 
            createIcon(randomMarker);
          randomMarker.info = createInfoDisplay(randomMarker);

          // TYPES OF TESTING
          // test input mode ('add divesite','add divesite parking','add place')
          mapData.center = randomMarker;     // 'add divesite parking'
          // mapData.markers = [randomMarker];  // 'add divesite' 
          // test display mode ('atlas','show divesite','show place')
          // if (mapData.markers) {mapData.markers.push(randomMarker);} 
          // else {mapData.markers = [randomMarker];} // 'atlas'
          // mapData.markers = [randomMarker];  // 'show divesite','show place'		  
		}

    </script>
</body>
</html>